{% extends "base.html" %}

{% block title %}Server Management - MCP Audit Management System{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item">
            <a href="{{ url_for('index') }}">Dashboard</a>
        </li>
        <li class="breadcrumb-item active">Server Management</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h2 mb-0">
            <i class="bi bi-server"></i> Server Management
        </h1>
        <p class="text-muted">Manage MCP servers and monitor their status</p>
    </div>
    <div class="col-md-4 text-md-end">
        <button class="btn btn-outline-primary" onclick="refreshAllStatus()">
            <i class="bi bi-arrow-clockwise"></i> Refresh Status
        </button>
    </div>
</div>

<!-- Current Server Info -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>Current Active Server:</strong> 
            {{ current_server or 'None selected' }}
            {% if current_server %}
                <span class="ms-2">
                    <i class="bi bi-circle-fill text-success"></i> Active
                </span>
            {% endif %}
        </div>
    </div>
</div>

<!-- Server Cards -->
<div class="row">
    {% for server_name, server_info in servers.items() %}
    <div class="col-lg-6 mb-4">
        <div class="card {% if server_info.is_current %}border-primary{% endif %}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-server"></i> {{ server_name }}
                    {% if server_info.is_current %}
                        <span class="badge bg-primary ms-2">Current</span>
                    {% endif %}
                </h5>
                <div class="server-status" data-server-status="{{ server_name }}">
                    {% if server_info.status.running %}
                        <span class="badge bg-success">
                            <i class="bi bi-circle-fill"></i> Running
                        </span>
                    {% else %}
                        <span class="badge bg-danger">
                            <i class="bi bi-circle"></i> Stopped
                        </span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <p class="card-text">{{ server_info.config.description }}</p>
                
                <dl class="row">
                    <dt class="col-sm-4">Transport:</dt>
                    <dd class="col-sm-8">{{ server_info.config.transport|upper }}</dd>
                    
                    <dt class="col-sm-4">Host:</dt>
                    <dd class="col-sm-8">{{ server_info.config.host }}</dd>
                    
                    <dt class="col-sm-4">Port:</dt>
                    <dd class="col-sm-8">{{ server_info.config.port }}</dd>
                    
                    {% if server_info.status.running %}
                    <dt class="col-sm-4">PID:</dt>
                    <dd class="col-sm-8">{{ server_info.status.pid }}</dd>
                    
                    <dt class="col-sm-4">Started:</dt>
                    <dd class="col-sm-8">{{ server_info.status.started_at[:19] if server_info.status.started_at else 'Unknown' }}</dd>
                    
                    <dt class="col-sm-4">Uptime:</dt>
                    <dd class="col-sm-8">
                        <span id="uptime-{{ server_name }}">
                            {% if server_info.status.uptime %}
                                {{ "%.0f"|format(server_info.status.uptime // 60) }} minutes
                            {% else %}
                                Unknown
                            {% endif %}
                        </span>
                    </dd>
                    {% endif %}
                </dl>
                
                <!-- Capabilities -->
                <div class="mt-3">
                    <h6>Capabilities:</h6>
                    <div class="d-flex flex-wrap gap-1">
                        {% for capability in server_info.config.capabilities %}
                        <span class="badge bg-secondary">{{ capability }}</span>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Tools -->
                {% if server_info.config.tools %}
                <div class="mt-3">
                    <h6>Available Tools:</h6>
                    <div class="d-flex flex-wrap gap-1">
                        {% for tool in server_info.config.tools %}
                        <span class="badge bg-info">{{ tool }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Action Buttons -->
                <div class="mt-4 d-flex gap-2">
                    {% if server_info.status.running %}
                        <form method="POST" action="{{ url_for('stop_server', server_name=server_name) }}" style="display: inline;">
                            <button type="submit" class="btn btn-danger btn-sm">
                                <i class="bi bi-stop-circle"></i> Stop
                            </button>
                        </form>
                        
                        {% if not server_info.is_current %}
                        <form method="POST" action="{{ url_for('switch_server', server_name=server_name) }}" style="display: inline;">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="bi bi-arrow-right-circle"></i> Switch To
                            </button>
                        </form>
                        {% endif %}
                    {% else %}
                        <form method="POST" action="{{ url_for('start_server', server_name=server_name) }}" style="display: inline;">
                            <button type="submit" class="btn btn-success btn-sm">
                                <i class="bi bi-play-circle"></i> Start
                            </button>
                        </form>
                    {% endif %}
                    
                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                            data-bs-toggle="modal" data-bs-target="#configModal{{ loop.index }}">
                        <i class="bi bi-gear"></i> Configure
                    </button>
                    
                    <button type="button" class="btn btn-outline-info btn-sm" 
                            onclick="testServer('{{ server_name }}')">
                        <i class="bi bi-check-circle"></i> Test
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Configuration Modal for each server -->
    <div class="modal fade" id="configModal{{ loop.index }}" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear"></i> Configure {{ server_name }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Server Name</label>
                                <input type="text" class="form-control" value="{{ server_name }}" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Transport</label>
                                <select class="form-select">
                                    <option value="stdio" {% if server_info.config.transport == 'stdio' %}selected{% endif %}>STDIO</option>
                                    <option value="http" {% if server_info.config.transport == 'http' %}selected{% endif %}>HTTP</option>
                                    <option value="sse" {% if server_info.config.transport == 'sse' %}selected{% endif %}>SSE</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Host</label>
                                <input type="text" class="form-control" value="{{ server_info.config.host }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Port</label>
                                <input type="number" class="form-control" value="{{ server_info.config.port }}">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" rows="2">{{ server_info.config.description }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Command Arguments</label>
                            <input type="text" class="form-control" value="{{ ' '.join(server_info.config.args) }}">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary">Save Configuration</button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- System Information -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> System Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Server Statistics</h6>
                        <dl class="row">
                            <dt class="col-sm-6">Total Servers:</dt>
                            <dd class="col-sm-6">{{ servers|length }}</dd>
                            
                            <dt class="col-sm-6">Running Servers:</dt>
                            <dd class="col-sm-6">
                                {{ servers.values() | selectattr('status.running') | list | length }}
                            </dd>
                            
                            <dt class="col-sm-6">Active Server:</dt>
                            <dd class="col-sm-6">{{ current_server or 'None' }}</dd>
                            
                            <dt class="col-sm-6">Configuration File:</dt>
                            <dd class="col-sm-6">server_config.json</dd>
                        </dl>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>System Status</h6>
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> System Operational
                        </div>
                        
                        <div class="mt-3">
                            <h6>Quick Actions</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="startAllServers()">
                                    <i class="bi bi-play-circle"></i> Start All Servers
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="stopAllServers()">
                                    <i class="bi bi-stop-circle"></i> Stop All Servers
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="exportConfiguration()">
                                    <i class="bi bi-download"></i> Export Configuration
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add New Server Modal -->
<div class="modal fade" id="addServerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> Add New Server
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addServerForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Server Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="serverName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Transport</label>
                            <select class="form-select" id="serverTransport">
                                <option value="stdio">STDIO</option>
                                <option value="http">HTTP</option>
                                <option value="sse">SSE</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Host</label>
                            <input type="text" class="form-control" id="serverHost" value="127.0.0.1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Port</label>
                            <input type="number" class="form-control" id="serverPort" value="8000">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="serverDescription" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Command</label>
                        <input type="text" class="form-control" id="serverCommand" value="python">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Arguments</label>
                        <input type="text" class="form-control" id="serverArgs" placeholder="server.py --transport stdio">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addNewServer()">Add Server</button>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<div class="position-fixed" style="bottom: 20px; right: 20px; z-index: 1050;">
    <button class="btn btn-primary rounded-circle" style="width: 56px; height: 56px;" 
            data-bs-toggle="modal" data-bs-target="#addServerModal">
        <i class="bi bi-plus-lg"></i>
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh server status every 10 seconds
    setInterval(refreshAllStatus, 10000);
    
    // Update uptime counters every minute
    setInterval(updateUptimes, 60000);
});

function refreshAllStatus() {
    const statusElements = document.querySelectorAll('[data-server-status]');
    statusElements.forEach(function(element) {
        const serverName = element.getAttribute('data-server-status');
        fetch(`/api/server/${serverName}/status`)
            .then(response => response.json())
            .then(data => {
                updateServerStatusDisplay(serverName, data);
            })
            .catch(error => console.error('Error fetching server status:', error));
    });
}

function updateServerStatusDisplay(serverName, status) {
    const statusElement = document.querySelector(`[data-server-status="${serverName}"]`);
    if (statusElement) {
        const badge = statusElement.querySelector('.badge');
        const icon = badge.querySelector('i');
        
        if (status.running) {
            badge.className = 'badge bg-success';
            icon.className = 'bi bi-circle-fill';
            badge.innerHTML = '<i class="bi bi-circle-fill"></i> Running';
        } else {
            badge.className = 'badge bg-danger';
            icon.className = 'bi bi-circle';
            badge.innerHTML = '<i class="bi bi-circle"></i> Stopped';
        }
    }
}

function updateUptimes() {
    {% for server_name, server_info in servers.items() %}
    {% if server_info.status.running %}
    const uptimeElement = document.getElementById('uptime-{{ server_name }}');
    if (uptimeElement) {
        fetch(`/api/server/{{ server_name }}/status`)
            .then(response => response.json())
            .then(data => {
                if (data.uptime) {
                    const minutes = Math.floor(data.uptime / 60);
                    uptimeElement.textContent = `${minutes} minutes`;
                }
            });
    }
    {% endif %}
    {% endfor %}
}

function testServer(serverName) {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Testing...';
    button.disabled = true;
    
    // Simulate server test
    setTimeout(() => {
        button.innerHTML = '<i class="bi bi-check-circle text-success"></i> Test Passed';
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        }, 2000);
    }, 2000);
}

function startAllServers() {
    if (confirm('Are you sure you want to start all servers?')) {
        // Implementation would go here
        alert('Starting all servers... (This would be implemented in the backend)');
    }
}

function stopAllServers() {
    if (confirm('Are you sure you want to stop all servers? This may interrupt ongoing operations.')) {
        // Implementation would go here
        alert('Stopping all servers... (This would be implemented in the backend)');
    }
}

function exportConfiguration() {
    // Create and download configuration file
    const config = {
        exported_at: new Date().toISOString(),
        servers: {{ servers | tojson }},
        current_server: '{{ current_server }}'
    };
    
    const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `server_config_backup_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function addNewServer() {
    const form = document.getElementById('addServerForm');
    const formData = new FormData(form);
    
    // Basic validation
    const serverName = document.getElementById('serverName').value;
    if (!serverName) {
        alert('Server name is required');
        return;
    }
    
    // Here you would send the data to the backend
    alert('Server configuration would be saved to the backend');
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addServerModal'));
    modal.hide();
    
    // Reset form
    form.reset();
}
</script>

<style>
.server-status .badge {
    font-size: 0.875rem;
}

.card.border-primary {
    border-width: 2px !important;
}

.timeline-small {
    max-height: 200px;
    overflow-y: auto;
}
</style>
{% endblock %}
